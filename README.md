# FFB_Position - 力反馈控制器

基于Arduino Leonardo的高精度力反馈控制器，专为游戏外设和模拟器设计。支持多种力反馈效果模式，包括通用模式、阻尼模式、振动模式、两段式模式和位置锁定模式。

## 系统概述

本固件实现了上位机与力反馈设备之间的通信和控制，主要实现以下功能：

1. 通过HID协议与上位机通信，接收模式和参数设置
2. 读取位置传感器数据，实时监测扳机位置
3. 根据当前模式和参数计算力反馈效果
4. 通过PWM信号控制电机输出，实现力反馈
5. 提供位置保护和限位功能，确保电机安全

### 系统交互流程图

```
+---------------+                +------------------+                +----------------+
|               |                |                  |                |                |
|   上位机       |<-----HID协议-->|  Arduino Leonardo|<----PWM控制--->|    力反馈电机   |
| (游戏/模拟器)  |                |  (力反馈控制器)   |                |                |
|               |                |                  |                |                |
+---------------+                +------------------+                +----------------+
                                         ^                                  |
                                         |                                  |
                                    模拟信号读取                             |
                                         |                                  |
                                         v                                  v
                                 +------------------+             +------------------+
                                 |                  |             |                  |
                                 |   位置传感器      |             |   力反馈效果      |
                                 | (扳机位置/电机位置)|<---------- | (阻尼/振动/锁定等) |
                                 |                  |             |                  |
                                 +------------------+             +------------------+
```

### 数据流程

1. **上位机到控制器**
   - 通过HID协议发送命令和参数
   - 设置力反馈模式和效果参数

2. **传感器到控制器**
   - 读取模拟位置信号
   - 通过滑动窗口进行滤波
   - 映射位置到PWM值

3. **控制器到电机**
   - 根据当前模式和位置计算力反馈效果
   - 生成PWM信号控制电机
   - 实现位置保护和限位功能

4. **控制器到上位机**
   - 通过串口发送调试信息
   - 可选发送状态和位置数据

## 主要特性

- 🎮 多模式力反馈效果
  - **通用模式 (0x10)**: 基础模式
    - 电机输出被禁用
    - 无特殊力反馈效果
    - 适用于需要完全手动控制的场景
    
  - **阻尼模式 (0x11)**: 位置相关阻尼效果
    - 可设置起始位置 (0-1023)
    - 阻尼强度可调 (0-255)
    - 适用于需要速度相关阻力的场景
    
  - **振动模式 (0x12)**: 振动效果
    - 可调振动频率 (1-255)
    - 可调振动强度 (0-255)
    - 可设置振动起始位置 (0-1023)
    - 适用于需要振动反馈的场景
    
  - **两段式模式 (0x13)**: 两段式效果
    - 可设置触发点位置 (0-1023)
    - 可设置行程长度 (0-1023)
    - 可调阻力大小 (0-255)
    - 适用于需要两段式触发的场景
    
  - **位置锁定模式 (0x14)**: 位置锁定功能
    - 可设置锁定位置 (0-1023)
    - 可调锁定力 (0-255)
    - 可设置阻尼起始位置 (0-1023)
    - 适用于需要固定位置的场景

- ⚙️ 可调参数
  - **阻尼效果**
    - 起始位置 (0-1023): 阻尼效果开始生效的位置
    - 阻尼强度 (0-255): 阻尼力的大小，值越大阻力越强
    - *示例*: 设置起始位置500，阻尼强度150，表示当位置超过500时会产生阻尼效果
  
  - **振动效果**
    - 起始位置 (0-1023): 振动效果开始的位置
    - 起始强度 (0-255): 振动开始时的强度
    - 振动强度 (0-255): 振动的最大强度
    - 振动频率 (0-255): 振动的速度，值越大振动越快
    - *示例*: 设置起始位置400，振动强度200，频率100，实现快速而强烈的振动效果
  
  - **触发设置**
    - 触发位置 (0-1023): 效果触发的绝对位置
    - 行程长度 (0-1023): 从触发位置开始的效果作用范围
    - *示例*: 设置触发位置600，行程200，表示当位置在600-800之间时效果生效
  
  - **阻力设置**
    - 基础阻力 (0-255): 静态阻力大小
    - 动态阻力 (0-255): 随速度变化的阻力
    - 死区 (0-50): 忽略微小位置变化的区域
    - *示例*: 设置基础阻力100，动态阻力50，死区5，提供平滑的阻力反馈

- 🛡️ 电机保护
  - 位置保护：防止电机超出设定区域(299-770)
  - 机械限位保护：在接近机械极限时提供额外保护
  - 位置死区控制：避免在极限位置附近震荡

## 硬件要求

- Arduino Leonardo 或兼容开发板
- 电机驱动模块
- 位置传感器（如电位器）
- 力反馈电机

## 引脚定义

| 引脚 | 功能 | 描述 |
|------|------|------|
| 5    | PWM1 | 电机控制PWM1 |
| 6    | PWM2 | 电机控制PWM2 |
| A0   | 电机位置 | 电机位置反馈 |
| A1   | 扳机位置 | 扳机位置输入 |

## 快速开始

### 1. 安装依赖

1. 安装 [Arduino IDE](https://www.arduino.cc/en/software) 或 [PlatformIO](https://platformio.org/)
2. 安装 [HID-Project](https://github.com/NicoHood/HID) 库
3. 烧录详细说明[图文](https://zaj7yix3t7i.feishu.cn/docx/UUfeduovLo7kduxYFeLcdeLSnvg)

### 2. 编译与上传

#### 使用PlatformIO:

```bash
# 克隆仓库
git clone https://github.com/yourusername/FFB_Position.git
cd FFB_Position

# 编译并上传
pio run -t upload
```

#### 使用Arduino IDE:
1. 打开`src/main.cpp`
2. 选择开发板: Arduino Leonardo
3. 选择正确的端口
4. 点击上传按钮

### 3. 连接硬件

1. 将电机连接到PWM1和PWM2引脚
2. 连接位置传感器到A0和A1
3. 连接电源

## 通信协议

### 数据包格式
```
[0xAA][命令][长度][数据...][0x55]
```

### 可用命令

| 命令 | 描述 | 数据格式 |
|------|------|----------|
| 0x01 | 设置模式 | [模式ID] |
| 0x02 | 设置参数 | [参数ID][参数值(2字节)] |

### 模式ID

| 模式ID | 模式名称 |
|--------|----------|
| 0x10   | 通用模式 |
| 0x11   | 阻尼模式 |
| 0x12   | 振动模式 |
| 0x13   | 两段式模式 |
| 0x14   | 位置锁定模式 |

## 参数配置

### 阻尼模式参数 (0x11)
- 0x21: 阻尼起始位置 (0-1023)
- 0x22: 阻尼强度 (0-255)

### 振动模式参数 (0x12)
- 0x31: 振动起始位置 (0-1023)
- 0x32: 起始强度 (0-255)
- 0x33: 振动强度 (0-255)
- 0x34: 振动频率 (0-255)
- 0x35: 振动起始数据 (0-65535)

### 两段式模式参数 (0x13)
- 0x41: 起始位置 (0-1023)
- 0x42: 扳机行程 (0-1023)
- 0x43: 阻力大小 (0-255)
- 0x44: 断点数据 (0-65535)

### 位置锁定模式参数 (0x14)
- 0x51: 阻尼起始位置 (0-1023)

## 函数参考

### 核心功能函数

| 函数名 | 参数 | 返回值 | 描述 |
|--------|------|--------|------|
| `setup()` | 无 | 无 | 初始化系统，配置引脚和HID通信 |
| `loop()` | 无 | 无 | 主循环，处理HID报告和效果更新 |
| `setMotorPWM(int pwm)` | pwm: PWM值(0-255) | 无 | 设置电机PWM输出 |
| `setupHighFrequencyPWM()` | 无 | 无 | 配置高频率PWM输出，消除电机噪音 |
| `getFilteredPosition(int pin, SlidingWindow& window)` | pin: 模拟输入引脚, window: 滑动窗口对象 | int: 滤波后的位置值 | 获取经过滑动窗口滤波后的位置值 |
| `mapPositionToPWM(int position)` | position: 位置值(299-770) | int: PWM值(1-255) | 将位置映射到PWM值 |

### HID通信函数

| 函数名 | 参数 | 返回值 | 描述 |
|--------|------|--------|------|
| `processHIDReport()` | 无 | 无 | 处理接收到的HID报告 |
| `processCommand()` | 无 | 无 | 处理接收到的命令 |
| `setMode(uint8_t modeId)` | modeId: 模式ID | 无 | 设置力反馈效果模式 |
| `setParameter(uint8_t paramId, uint16_t value)` | paramId: 参数ID, value: 参数值 | 无 | 设置效果参数 |

### 效果处理函数

| 函数名 | 参数 | 返回值 | 描述 |
|--------|------|--------|------|
| `updateEffect()` | 无 | 无 | 更新当前力反馈效果 |
| `impactEffect(int startStrength, int pwmStrength, int frequency)` | startStrength: 起始强度, pwmStrength: PWM强度, frequency: 频率 | 无 | 实现冲击效果 |
| `printEffectInfo()` | 无 | 无 | 打印当前效果信息 |

### 辅助函数

| 函数名 | 参数 | 返回值 | 描述 |
|--------|------|--------|------|
| `isPositionSafe(int position)` | position: 位置值 | bool: 是否安全 | 检查位置是否在安全范围内 |
| `SlidingWindow.addValue(int newValue)` | newValue: 新值 | int: 滑动窗口平均值 | 添加新值并返回窗口平均值 |

## 代码运行逻辑流程图

### 系统总体流程

```
+-------------------+     +-------------------+     +-------------------+
|    系统初始化     |---->|    主循环(loop)    |---->|   力反馈效果更新    |
|    (setup)       |     |                   |     |   (updateEffect)   |
+-------------------+     +-------------------+     +-------------------+
         |                        |                          |
         v                        v                          v
+-------------------+     +-------------------+     +-------------------+
|  配置高频PWM输出   |     |   处理HID数据     |     |    电机控制输出    |
| setupHighFreqPWM  |     | processHIDReport |     |    setMotorPWM    |
+-------------------+     +-------------------+     +-------------------+
```

### 数据处理流程

```
+-------------------+     +-------------------+     +-------------------+
|   读取位置数据      |---->|    滤波处理      |---->|    映射到PWM值       | 
| getFilteredPosition|     |  (滑动窗口平均)  |     |   mapPositionToPWM  |
+-------------------+     +-------------------+     +-------------------+
         |                                                    |
         v                                                    v
+-------------------+                              +-------------------+
|   位置安全检查     |                              |    应用力反馈效果   |
|  isPositionSafe   |                              |    (根据当前模式)   |
+-------------------+                              +-------------------+
```

### 模式切换流程

```
+-------------------+     +-------------------+     +-------------------+
|    接收HID命令     |---->|    解析命令类型    |---->|   设置模式/参数      |
|  processCommand   |     |                   |     | setMode/setParameter|
+-------------------+     +-------------------+     +-------------------+
                                                              |
                                                              v
                                                    +-------------------+
                                                    |   更新当前效果状态 |
                                                    |   (激活/参数设置)  |
                                                    +-------------------+
```

### 力反馈效果处理

```
                    +-------------------+
                    |   当前效果类型     |
                    | currentEffect.type|
                    +-------------------+
                             |
                             v
      +---------+------------+-----------+-----------+
      |         |            |           |           |
      |         |            |           |           |
      v         v            v           v           v
+---------+ +---------+ +---------+ +---------+ +----------+
| 通用模式 | | 阻尼模式 || 振动模式 | | 两段模式 | | 锁定模式  |
| (0x10)  | | (0x11)  | | (0x12)  | | (0x13)  | | (0x14)   |
+---------+ +---------+ +---------+ +---------+ +----------+
     |           |           |           |           |
     v           v           v           v           v
+---------+ +----------+ +---------+ +--------+ +----------+
| 禁用电机 | | 位置相关 | | 振动效果 | | 两段式  | | 位置锁定 |
| 输出     | | 阻尼力  | | 处理     | | 触发处理| | 处理     |
+---------+ +----------+ +---------+ +--------+ +----------+
```

## 调试指南

本项目提供了全面的调试功能，便于开发者快速定位问题和进行二次开发。主要通过串口监视器进行调试，配置参数如下：

- **波特率**: 115200 baud
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无
- **流控制**: 无

### 开启调试输出

调试输出默认已启用。如需要自定义调试输出，可以修改以下参数：

```cpp
// 在main.cpp中修改这些参数

const uint32_t SERIAL_BAUD = 115200;  // 串口波特率
const unsigned long USB_DEBUG_INTERVAL = 5000; // 定期调试信息间隔(毫秒)
const int POSITION_PRINT_THRESHOLD = 5;  // 位置变化输出阈值
```

### 调试信息类型

| 信息类型 | 格式 | 描述 | 例子 |
|------------|------|------|------|
| 初始化信息 | `Force Feedback Controller Initializing...` | 系统启动时输出 | `Force Feedback Controller Initializing...` |
| 模式切换 | `Mode set to: 0xXX` | 模式切换时输出 | `Mode set to: 0x11` |
| 参数设置 | `Parameter set: 0xXX = YYY` | 参数设置时输出 | `Parameter set: 0x21 = 500` |
| 位置数据 | `Motor Pos: XXX` 和 `Trigger Pos: YYY` | 位置变化超过阈值时输出 | `Motor Pos: 450` 和 `Trigger Pos: 120` |
| 命令错误 | `Invalid command format` 或 `Checksum error` | 命令格式或校验和错误 | `Invalid command format` |
| 效果信息 | 当前模式及相关参数 | 调用`printEffectInfo()`时输出 | `Type: 0x11, Start Position: 500, Damping Strength: 150` |

### 常见问题调试

| 问题 | 可能原因 | 调试方法 |
|--------|----------|----------|
| 电机不响应 | 1. `motorState.enabled = false`<br>2. PWM值过低 | 检查`motorState.enabled`状态和输出的PWM值 |
| 位置数据不准确 | 1. 传感器连接问题<br>2. 滑动窗口参数设置不当 | 直接输出原始位置数据进行比较 |
| 命令不被识别 | 1. 命令格式错误<br>2. 校验和计算错误 | 检查命令格式和校验和计算 |
| 效果不符合预期 | 1. 参数设置不当<br>2. 模式切换错误 | 调用`printEffectInfo()`查看当前效果参数 |

### 二次开发调试技巧

1. **添加自定义调试点**：在关键位置添加`Serial.print()`输出变量值

   ```cpp
   Serial.print(F("Debug - Variable: ")); Serial.println(myVariable);
   ```

2. **使用F()宏**：将字符串存储在程序存储区而非内存，节省RAM

3. **定位性能瓶颈**：在函数开始和结束处添加时间戳记录

   ```cpp
   unsigned long startTime = millis();
   // 函数代码
   Serial.print(F("Function execution time: ")); Serial.println(millis() - startTime);
   ```

4. **使用条件编译**：通过预处理指令控制调试输出

   ```cpp
   #define DEBUG_MODE 1
   
   #if DEBUG_MODE
   Serial.println(F("Debug information"));
   #endif
   ```

## 安全注意事项

1. 确保电源电压和电流在硬件规格范围内
2. 避免长时间以最大PWM运行电机
3. 定期检查连接线是否松动

## 许可证

MIT License

## 贡献

欢迎提交Issue和Pull Request。对于重大更改，请先开Issue讨论您想要更改的内容。

## 致谢

- [HID-Project](https://github.com/NicoHood/HID)
